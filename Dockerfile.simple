FROM eclipse-temurin:21-jdk-alpine

# Instalar ferramentas necessárias
RUN apk add --no-cache curl wget postgresql-client

# Definir diretório de trabalho
WORKDIR /app

# Copiar todo o projeto
COPY . .

# Dar permissão de execução ao mvnw
RUN chmod +x ./mvnw

# Limpar build anterior, compilar e verificar o JAR
RUN ./mvnw clean package -DskipTests && \
    echo "Arquivos gerados:" && \
    ls -la target && \
    echo "JARs encontrados:" && \
    find target -name "*.jar" -type f | xargs ls -la

# Criar script de inicialização para verificar conexão com banco
RUN echo '#!/bin/sh' > /app/start.sh && \
    echo 'echo "Aguardando conexão com o banco de dados..."' >> /app/start.sh && \
    echo 'RETRIES=30' >> /app/start.sh && \
    echo 'while [ $RETRIES -gt 0 ]' >> /app/start.sh && \
    echo 'do' >> /app/start.sh && \
    echo '  if pg_isready -h $DB_HOST -p $DB_PORT -U $DB_USER; then' >> /app/start.sh && \
    echo '    echo "Banco de dados conectado!"' >> /app/start.sh && \
    echo '    break' >> /app/start.sh && \
    echo '  fi' >> /app/start.sh && \
    echo '  RETRIES=$((RETRIES-1))' >> /app/start.sh && \
    echo '  echo "Tentando novamente em 5 segundos... ($RETRIES tentativas restantes)"' >> /app/start.sh && \
    echo '  sleep 5' >> /app/start.sh && \
    echo 'done' >> /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo 'echo "Iniciando aplicação com as seguintes variáveis de ambiente:"' >> /app/start.sh && \
    echo 'echo "DB_HOST: $DB_HOST"' >> /app/start.sh && \
    echo 'echo "DB_PORT: $DB_PORT"' >> /app/start.sh && \
    echo 'echo "DB_NAME: $DB_NAME"' >> /app/start.sh && \
    echo 'echo "JDBC_DATABASE_URL: $JDBC_DATABASE_URL"' >> /app/start.sh && \
    echo 'echo "Profile: $SPRING_PROFILES_ACTIVE"' >> /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo 'JAR_FILE=$(find target -name "*.jar" -not -name "*sources.jar" -not -name "*javadoc.jar" | head -1)' >> /app/start.sh && \
    echo 'echo "Usando JAR: $JAR_FILE"' >> /app/start.sh && \
    echo 'java -Dspring.datasource.hikari.maximum-pool-size=5 -Dspring.datasource.hikari.connection-timeout=60000 -jar $JAR_FILE --spring.profiles.active=$SPRING_PROFILES_ACTIVE' >> /app/start.sh && \
    chmod +x /app/start.sh

# Expor a porta
EXPOSE 8080

# Comando para iniciar a aplicação
CMD ["/app/start.sh"] 